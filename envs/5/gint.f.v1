cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
c
c  For evolution of galaxies (test particle method) 
c    by Kenji Bekki, 2018/1/12
c
c  For Eleanor & Mark
c  Program name:  gint.f
c
cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
c/*
c#include <g5util.h>
c*/

#define REAL real*8
#define NJMAX (2000000)
#define NEIMAX (20000)

      program gint

      REAL mj(NJMAX), xj(3, NJMAX), vj(3, NJMAX)
      REAL gp(10),unit(10)
      REAL a(3, NJMAX), p(NJMAX)
      REAL xmax, xmin, mmin
      REAL eps, dt, endt, time, es(1000),sm(1000),dti(10),
     &      dti2(10),vm(5),vmi(2,100000),pv(7,100000)
      REAL e, e0, ke, pe, ages,sunfs,sunfe,tinf
      integer i, j, k, iwas(NJMAX), nspe,ncomt,icen(10),
     &        iwa(NJMAX),id(NJMAX),nmc(2,3)
      integer nj,nsun,idsun(NJMAX),idnei(NEIMAX),neit,isun,nsout
      integer nstep, step, imode, hmode, nmod,iext,itid

      open(unit=1,file='time.para',status='old')
      open(unit=4,file='unit.para',status='old')
      open(unit=7,file='gpot.para',status='old')

c      read(1,*) endt,dt,imode,hmode,nmod,iext
      read(1,*) endt,dt,imode,hmode,nmod


      read(4,*) (unit(k),k=1,3)


c      do 1 k=1,7
      do 1 k=1,8
      read(7,*) gp(k)
 1    continue

      iext=int(gp(8))
c      write(6,*) 'iext=',iext
c      iext=2

      gp(1)=gp(1)/unit(2)
      gp(2)=gp(2)/unit(2)
      gp(3)=gp(3)/unit(2)
      gp(4)=gp(4)/unit(2)
      gp(5)=gp(5)/unit(1)
      gp(6)=gp(6)/unit(1)
      gp(7)=gp(7)/unit(3)
      write(6,*) 'unit',(unit(k),k=1,3)
      write(6,*) 'gp',(gp(k),k=1,7)
c      stop

c------New version multiple-time step
c
c dt =  GC time step  dt_g= Galaxy time step= dt*nmod
c
c  id=1 for all GC stars id=1 only for nmod time steps
c
c------
      time = 0.0
      nstep = endt/dt

      nstep=nstep+1

cccc For initial data sets
      call readnbody(nj, xj, vj, iwas, time)
      call writenbody(nj, xj, vj, iwas, time)

      call calc_ext(nj,xj,a,gp,id)

      do step=1,nstep /* main loop */

      call push_velocity(vj, a, 0.5*dt, nj, iwas, id)
      call push_position(xj, vj, a, dt, nj, iwas, id)
      time = time + dt
      call calc_ext(nj,xj,a,gp,id)
      call push_velocity(vj, a, 0.5*dt, nj, iwas, id)

      if (mod(step, imode).eq. 0) then
      call writenbody(nj, mj, xj, vj, iwas, nspe, es, sm, time)
      nsout=nsout+1
      end if


      enddo


      call writenbody(nj, xj, vj, iwas, time)

      end

c-----End of the program


c-----For velocity update

      subroutine push_velocity(vj, a, dt, nj)
      REAL vj(3, NJMAX)
      REAL a(3, NJMAX)
      REAL dt
      integer nj
      integer j, k

      do j=1,nj
	do k=1,3
	   vj(k,j) = vj(k,j) + dt*a(k,j)
	enddo
      enddo
      end

c-----For velocity update

      subroutine push_position(xj,vj,a,dt,nj)
      REAL xj(3, NJMAX)
      REAL vj(3, NJMAX)
      REAL a(3, NJMAX)
      REAL dti(10)
      integer nj,iwas(NJMAX),id(NJMAX)
      integer j, k

      do j=1, nj
	 do k=1,3
	    xj(k,j) = xj(k,j) + dt*vj(k,j)
	 enddo
      enddo
      end

c-----  Input of position data

      subroutine readnbody(nj, mj, xj, vj, iwas, nspe, es, sm)
      integer nj
      REAL mj(NJMAX), xj(3, NJMAX), vj(3, NJMAX), 
     &     es(1000), sm(1000)
      integer i, dummy, iwas(NJMAX), nspe
      REAL ddummy

      open(unit=11,file='tinit.dat',status='old')

      read(11,*) nj,time
      do i=1,nj
      read(11,*)(xj(k,i),k=1,3), (vj(k,i),k=1,3)
      enddo

      end

c-----  Output of position data

      subroutine writenbody(nj, mj, xj, vj, iwas, nspe, es, sm, time)
      integer nj
      REAL mj(NJMAX), xj(3, NJMAX), vj(3, NJMAX), 
     &     es(1000), sm(1000)
      REAL time
      integer i, dummy, iwas(NJMAX), nspe, kk

c      open(unit=12,file='tout.dat',status='new')
      open(unit=12,file='tout.dat')


      write(12,601) nj,time
      do i=1,nj
         write(12,604)(xj(k,i),k=1,3), (vj(k,i),k=1,3)
      enddo
 601  format(i10,1(1pe13.5))
c 602  format(i3)
c 603  format(5(1pe13.5))
 604  format(6(1pe13.5))
c 604  format(6(1pe13.5),i3)

      end


c-----   Calculations for  external  force from the Galaxy

      subroutine calc_ext(nj,xj,a,gp,id)
      REAL xj(3, NJMAX)
      REAL  a(3, NJMAX),gp(10)
      integer nj,id(NJMAX)

c      write(6,*) 'ENTER EXTERNAL MW'
      do 100 i=1,nj


      x01=xj(1,i)
      x02=xj(2,i)
      x03=xj(3,i)
      r0=sqrt(x01**2.+x02**2.+x03**2.)

c---From halo
      p1=2.*r0*gp(7)**2.0
      p2=p1/(r0**2.+gp(4)**2.)
      fh=-p2

      fhx=x01/r0*fh
      fhy=x02/r0*fh
      fhz=x03/r0*fh

      a(1,i) = a(1,i)+fhx
      a(2,i) = a(2,i)+fhy
      a(3,i) = a(3,i)+fhz

c---From disk
      p1=x01*gp(5)
      p2=x01**2.+x02**2.
      p3=sqrt(x03**2.+gp(2)**2.)
      p4=(gp(1)+p3)**2.
      p5=(p2+p4)**1.5
      p6=p1/p5
      fhx=-p6

      p1=x02*gp(5)
      p2=x01**2.+x02**2.
      p3=sqrt(x03**2.+gp(2)**2.)
      p4=(gp(1)+p3)**2.
      p5=(p2+p4)**1.5
      p6=p1/p5
      fhy=-p6

c      p1=x03*gp(5)
      p2=x01**2.+x02**2.
      p3=sqrt(x03**2.+gp(2)**2.)
      p4=(gp(1)+p3)**2.
      p5=(p2+p4)**1.5
      p6=x03**2.+gp(2)**2.
      p7=gp(1)/sqrt(p6)
      p8=x03*(p7+1.0)
      p9=p8/p5
      fhz=-p9

      a(1,i) = a(1,i)+fhx
      a(2,i) = a(2,i)+fhy
      a(3,i) = a(3,i)+fhz


c---From bulge
      fh=-gp(6)/(r0+gp(3))**2.

      fhx=x01/r0*fh
      fhy=x02/r0*fh
      fhz=x03/r0*fh

      a(1,i) = a(1,i)+fhx
      a(2,i) = a(2,i)+fhy
      a(3,i) = a(3,i)+fhz


      end if

 100  continue

      end 

